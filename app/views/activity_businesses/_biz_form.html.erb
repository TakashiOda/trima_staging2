<%= form_for [@supplier, @activity_business] do |form| %>
  <div class="form_title">
    <h3>体験事業の情報を編集</h3>
  </div>
  <div class="user_show_content_down">
    <%= render 'layouts/error_messages', model: form.object %>
    <div class="user_show_info_items_box">
      <section class="form_section">
        <div class="form_big_title">
          <h3>体験事業の基本情報</h3>
        </div>
        <div class="user_edit_image_container">
          <div class="form-group user_edit_image_box">
            <div class="user_edit_image_box_inside">
              <img id="user_image_prev" src="#" class="hidden" />
              <% if current_supplier && @activity_business.profile_image? %>
                <%= image_tag @activity_business.profile_image.to_s, class: 'user_present_image', id: 'user_present_image' %>
              <% else %>
                <%= image_tag 'default_images/no_avatar_for_biz.png', class: 'user_present_image', id: 'user_present_image' %>
                <%= form.hidden_field :profile_image_cache %>
              <% end %>
            </div>
            <div id="user_edit_image_upload_btn_box">
              <%= form.file_field :profile_image, id: 'post_image', oninput: 'hasInput()' %>
              <span id="user_edit_image_upload_btn" onclick="image_input_btn()"><i class="fas fa-camera"></i></span>
            </div>
          </div>
        </div>
        <div class="activity_description_language_box">
          <ul class="activity_description_language_box_tab_list" role="tablist">
            <li id="japanese_tab" class="active" onclick="toggleDescriptionTab(this)">
              <span>日本語</span>
            </li>
            <li id="english_tab" onclick="toggleDescriptionTab(this)">
              <span>英語</span>
            </li>
            <li id="chinese_tab" onclick="toggleDescriptionTab(this)">
              <span>中国語（簡体字）</span>
            </li>
            <li id="taiwanese_tab" onclick="toggleDescriptionTab(this)">
              <span>中国語（繁体字）</span>
            </li>
          </ul>
          <div class="tab-content-items">
            <div id="japanese_tab_content">
              <div class="form-group">
                <%= form.label "企業名または屋号" %>
                <%= form.text_field :name, minlength: 3, maxlength: 50, required: true, class: "form-control", oninput: 'hasInput()' %>
              </div>
              <div class="form-group">
                <label><span>企業・事業の紹介文（日本語・残り</span><span id="biz_japanese_description_count">200</span><span>字）</span></label>
                <%= form.text_area :profile_text, rows: 7, minlength: 20, maxlength: 200, required: true, class: "form-control", oninput: 'countBizDescriptionJP(this)' %>
              </div>
            </div>
            <div class="hidden" id="english_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号（英語）" %>
                <%= form.text_field :en_name, maxlength: 40, class: "form-control", oninput: 'hasInput()' %>
              </div>
              <div class="form-group">
                <label><span>企業・事業の紹介文（英語・残り</span><span id="biz_english_description_count">200</span><span>字）</span></label>
                <%= form.text_area :en_profile_text, size: "22x5", maxlength: 200, class: "form-control", oninput: 'countBizDescriptionEN(this)' %>
              </div>
            </div>
            <div class="hidden" id="chinese_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号（中国語・簡体字）" %>
                <%= form.text_field :cn_name, maxlength: 40, class: "form-control", oninput: 'hasInput()' %>
              </div>
              <div class="form-group">
                <label><span>企業・事業の紹介文（中国語・簡体字・残り</span><span id="biz_chinese_description_count">200</span><span>字）</span></label>
                <%= form.text_area :cn_profile_text, size: "22x5", maxlength: 200, class: "form-control", oninput: 'countBizDescriptionCN(this)' %>
              </div>
            </div>
            <div class="hidden" id="taiwanese_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号（中国語・繁体字）" %>
                <%= form.text_field :tw_name, maxlength: 40, class: "form-control", oninput: 'hasInput()' %>
              </div>
              <div class="form-group">
                <label><span>企業・事業の紹介文（中国語・繁体字・残り</span><span id="biz_taiwanese_description_count">200</span><span>字）</span></label>
                <%= form.text_area :tw_profile_text, size: "22x5", maxlength: 200, class: "form-control", oninput: 'countBizDescriptionTW(this)' %>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>ガイド・案内人情報</h3>
        </div>
        <div id="guides">
          <%= form.fields_for :guides do |g| %>
            <%= render "guide_fields", f: g %>
          <% end %>
          <div class="links">
            <%= link_to_add_association "ガイドを追加", form, :guides, onClick: "addIdToGuideItem(this)" %>
          </div>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>対応可能言語</h3>
        </div>
        <div class="form-group language_activity_list">
          <%= form.collection_check_boxes :language_ids, Language.where(id: [3,26,28]), :id, :name, {}, {:onChange=>"hasInput();"} %>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>体験のキャンセル設定</h3>
        </div>
        <div class="radio_item_box">
          <%= form.label "無料キャンセルの期限" %>
          <div class="radio_items cansel_setting_radio">
            <div class="radio_item">
              <%= form.radio_button :no_charge_cansel_before, :the_day_before, onClick: 'showExplanation(this)', oninput: 'hasInput()' %>
              <%= form.label :no_charge_cansel_before, "前日まで無料/それ以降は100%", {value: :the_day_before, style: "display: inline-block;"} %>
            </div>
            <div class="radio_item">
              <%= form.radio_button :no_charge_cansel_before, :three_days_before, onClick: 'showExplanation(this)', oninput: 'hasInput()' %>
              <%= form.label :no_charge_cansel_before, "3日前まで無料/それ以降は100%", {value: :three_days_before, style: "display: inline-block;"} %>
            </div>
            <div class="radio_item">
              <%= form.radio_button :no_charge_cansel_before, :a_week_before, onClick: 'showExplanation(this)', oninput: 'hasInput()' %>
              <%= form.label :no_charge_cansel_before, "1週間前まで無料/それ以降は100%", {value: :a_week_before, style: "display: inline-block;"} %>
            </div>
          </div>
        </div>
        <div class="explanation_about_cansel">
          <div id="explanation_about_the_day_before" class="">
            <div class="hosoku_title_box">
              <span class="hosoku_title">補足</span>
              <span class="hosoku_sub_title">前日まで無料の場合</span>
            </div>
            <ul>
              <li>ユーザーが体験実施日の前日23時59分（現地時間）までにキャンセルする場合、
              無料キャンセルとなり体験料金は事業者様に支払われません。</li>
              <li>例えば体験実施日が1月20日の場合、前日1月19日の23時59分までにキャンセルされた場合は
                無料キャンセルとなり事業者様に料金は支払われず、
                1月20日0時00分を過ぎてキャンセルされた場合は通常の手数料を差し引いた
                体験料金の100%が事業者様に支払われます。</li>
            </ul>
          </div>
          <div id="explanation_about_three_days_before" class="hidden">
            <div class="hosoku_title_box">
              <span class="hosoku_title">補足</span>
              <span class="hosoku_sub_title">３日前まで無料の場合</span>
            </div>
            <ul>
              <li>ユーザーが体験実施日の3日前の23時59分（現地時間）までにキャンセルする場合、
              無料キャンセルとなり体験料金は事業者様に支払われません。</li>
              <li>例えば体験実施日が1月20日の場合、３日前の1月17日の23時59分までにキャンセルされた場合は
                無料キャンセルとなり事業者様に料金は支払われず、
                1月18日0時00分を過ぎてキャンセルされた場合は通常の手数料を差し引いた
                体験料金の100%が事業者様に支払われます。</li>
            </ul>
          </div>
          <div id="explanation_about_a_week_before" class="hidden">
            <div class="hosoku_title_box">
              <span class="hosoku_title">補足</span>
              <span class="hosoku_sub_title">１週間前まで無料の場合</span>
            </div>
            <ul>
              <li>ユーザーは体験を実施日の１週間前の23時59分（現地時間）までにキャンセルする場合、
              無料キャンセルとなり体験料金は事業者様に支払われません。</li>
              <li>例えば体験実施日が1月20日の場合、１週間前の1月13日の23時59分までにキャンセルされた場合は
                無料キャンセルとなり事業者様に料金は支払われず、
                1月14日0時00分を過ぎてキャンセルされた場合は通常の手数料を差し引いた
                体験料金の100%が事業者様に支払われます。</li>
            </ul>
          </div>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>保険加入について</h3>
        </div>
        <div class="form-group">
          <%= form.label "加入保険の証書アップロード" %>
          <%= form.file_field :insurance_image, id: 'insurance_image_form', oninput: 'hasInput()' %>
        </div>
        <div class="explanation_about_cansel">
          <div id="explanation_about_the_day_before" class="">
            <div class="hosoku_title_box">
              <span class="hosoku_title">補足</span>
              <span class="hosoku_sub_title">保険の加入について</span>
            </div>
            <ul>
              <li>保険の加入と保険への加入は任意ですが、保険への加入有無はユーザーに表示されます</li>
              <li>提供されるアクティビティによっては（ウォータースポーツなど）保険への加入を必須とさせていただく場合がございます。</li>
            </ul>
          </div>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>所在地・連絡先</h3>
        </div>
        <div class="radio_item_box">
          <%= form.label "住所" %>
          <div class="radio_items">
            <div class="radio_item on">
              <%= form.radio_button :apply_suuplier_address, :true, onClick: "applySupplierAddress(this)", oninput: 'hasInput()' %>
              <%= form.label :apply_suuplier_address, "アカウント登録住所と同じ", {value: :true, style: "display: inline-block;"} %>
            </div>
            <div class="radio_item off">
              <%= form.radio_button :apply_suuplier_address, :false, onClick: "hasOwnSupplierAddress(this)", oninput: 'hasInput()' %>
              <%= form.label :apply_suuplier_address, "別の住所を設定する", {value: :false, style: "display: inline-block;"} %>
            </div>
          </div>
        </div>
        <div id="address_box" class="<%= "hidden" if @activity_business.apply_suuplier_address %>">
          <div class="form-group">
            <div class="form-group">
              <%= form.label "郵便番号" %>
              <%= form.text_field :post_code, class: "form-control", oninput: 'hasInput()' %>
            </div>
            <div class="row">
              <div class="col-half">
                <%= form.label "都道府県" %>
                <%# form.collection_select :prefecture_id, Prefecture.all, :id, :local_name,{prompt: "都道府県を選択"}, required: true, class: "form-control" %>
                <%= form.select :prefecture_id, {'北海道': 2}, { include_blank: false}, { class: 'form-control' } %>
              </div>
              <div class="col-half">
                <%= form.label "市区町村" %>
                <%= form.collection_select :town_id, Town.all, :id, :jp_name,{prompt: "市区町村を選択"}, class: "form-control", oninput: 'hasInput()' %>
              </div>
            </div>
            <div class="form-group">
              <%= form.label "住所" %>
              <%= form.text_field :detail_address, maxlength: 100, class: "form-control", oninput: 'hasInput()' %>
            </div>
            <div class="form-group">
              <%= form.label "建物名・部屋番号など" %>
              <%= form.text_field :building, maxlength: 100, class: "form-control", oninput: 'hasInput()' %>
            </div>
          </div>
        </div>
        <div class="radio_item_box">
          <%= form.label "電話番号" %>
          <div class="radio_items">
            <div class="radio_item on">
              <%= form.radio_button :apply_suuplier_phone, :true, onClick: "applySupplierPhone(this)", oninput: 'hasInput()' %>
              <%= form.label :apply_suuplier_phone, "アカウント登録電話番号と同じ", {value: :true, style: "display: inline-block;"} %>
            </div>
            <div class="radio_item off">
              <%= form.radio_button :apply_suuplier_phone, :false, onClick: "hasOwnSupplierPhone(this)", oninput: 'hasInput()' %>
              <%= form.label :apply_suuplier_phone, "別の電話番号を設定する", {value: :false, style: "display: inline-block;"} %>
            </div>
          </div>
        </div>
        <div id="phone_box" class="<%= "hidden" if @activity_business.apply_suuplier_phone %>">
          <div class="form-group">
            <%= form.label "別の電話番号を入力してください（ハイフンなし）" %>
            <%= form.text_field :phone, class: "form-control", oninput: 'hasInput()' %>
          </div>
        </div>
      </section>
    </div>
    <div class="user_show_info_button_box">
      <div class="form_sidebtns_container">
        <div class="form_sidebtns">
          <div class="form_sidebtn">
            <%= link_to "キャンセル", supplier_path(current_supplier), class: "button btn-cansel" %>
          </div>
          <div class="form_sidebtn">
            <%= form.submit('更新する',class: 'button btn-submit', id: "biz_form_submit_btn") %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<style>
  .radio_items.cansel_setting_radio {
    display: flex;
    flex-direction: column;
    margin-top: 10px;
  }
  .radio_items.cansel_setting_radio .radio_item {
    display: flex;
    align-items: center;
    border: solid 1px lightgray;
    margin-bottom: 3px;
    padding: 5px 0px;
    border-radius: 5px;
    width: 100%;
    height: 30px;
  }
  .radio_items.cansel_setting_radio input {
    margin-left: 15px;
    width: 10%;
    height: 20px;
  }
  .radio_items.cansel_setting_radio label {
    width: 90%;
  }
  .hosoku_title {
    font-size: 12px;
    background: #d0d0d0;
    display: inline-block;
    padding: 1px 15px;
    color: gray;
    border-radius: 30px;
    margin: 0;
  }
  .hosoku_sub_title {
    margin: 3px 0;
    color: gray;
    font-size: 15px;
  }
  div#explanation_about_the_day_before ul,
  div#explanation_about_three_days_before ul,
  div#explanation_about_a_week_before ul {
    list-style: disc !important;
    padding-left: 20px;
    margin: 15px 0;
  }
  div#explanation_about_the_day_before ul li,
  div#explanation_about_three_days_before ul li,
  div#explanation_about_a_week_before ul li {
    font-size: 12px;
    color: gray;
    margin-bottom: 5px;
  }


</style>

<script type="text/javascript">
  (window.onload = function() {
    //読み込み時に残り文字数カウント
    const description = document.getElementById('activity_business_profile_text');
    const enDescription = document.getElementById('activity_business_en_profile_text');
    const cnDescription = document.getElementById('activity_business_cn_profile_text');
    const twDescription = document.getElementById('activity_business_tw_profile_text');
    changeCountAndColor(description, 'biz_japanese_description_count', 200)
    changeCountAndColor(enDescription, 'biz_english_description_count', 200)
    changeCountAndColor(cnDescription, 'biz_chinese_description_count', 200)
    changeCountAndColor(twDescription, 'biz_taiwanese_description_count', 200)

    const theDayBeforeRadio = document.getElementById("activity_business_no_charge_cansel_before_the_day_before");
    const threeDaysBeforeRadio = document.getElementById("activity_business_no_charge_cansel_before_three_days_before");
    const aWeekBeforeRadio = document.getElementById("activity_business_no_charge_cansel_before_a_week_before");
    // console.log(theDayBeforeRadio.checked);
    if (theDayBeforeRadio.checked) {
      showExplanationWithValue('the_day_before');
    } else if (threeDaysBeforeRadio.checked) {
      showExplanationWithValue('three_days_before');
    } else {
      showExplanationWithValue('a_week_before');
    }

  })();

  function hasInput() {
    const submitBtn = document.getElementById('biz_form_submit_btn');
    submitBtn.classList.add('need_submit');
  }

  function countBizDescriptionJP(obj) {
    hasInput();
    changeCountAndColor(obj, 'biz_japanese_description_count', 200);
  }
  function countBizDescriptionEN(obj) {
    hasInput();
    changeCountAndColor(obj, 'biz_english_description_count', 200);
  }
  function countBizDescriptionCN(obj) {
    hasInput();
    changeCountAndColor(obj, 'biz_chinese_description_count', 200);
  }
  function countBizDescriptionTW(obj) {
    hasInput();
    changeCountAndColor(obj, 'biz_taiwanese_description_count', 200);
  }

  // textを変更するtarget idと数字を入れると、数字を超えたときにtargetのtextと色を変えてくれる
  function changeCountAndColor(obj, targetId, textNum) {
    const leftTextTarget = document.getElementById(targetId);
    leftTextTarget.innerHTML = textNum-obj.value.length;
    if ((textNum-obj.value.length) < 20) {
      leftTextTarget.style.color = 'red';
    } else {
      leftTextTarget.style.color = '#8a8a8a';
    }
  }

  function toggleDescriptionTab(obj) {
    const tabId = obj.id;
    const japaneseTab = document.getElementById('japanese_tab');
    const englishTab = document.getElementById('english_tab');
    const chineseTab = document.getElementById('chinese_tab');
    const taiwaneseTab = document.getElementById('taiwanese_tab');

    const japaneseContent = document.getElementById('japanese_tab_content');
    const englishContent = document.getElementById('english_tab_content');
    const chineseContent = document.getElementById('chinese_tab_content');
    const taiwaneseContent = document.getElementById('taiwanese_tab_content');

    if (tabId == 'japanese_tab') {
      japaneseTab.classList.add('active');
      englishTab.classList.remove('active');
      chineseTab.classList.remove('active');
      taiwaneseTab.classList.remove('active');

      japaneseContent.classList.remove('hidden');
      englishContent.classList.add('hidden');
      chineseContent.classList.add('hidden');
      taiwaneseContent.classList.add('hidden');
    } else if (tabId == 'english_tab') {
      japaneseTab.classList.remove('active');
      englishTab.classList.add('active');
      chineseTab.classList.remove('active');
      taiwaneseTab.classList.remove('active');

      japaneseContent.classList.add('hidden');
      englishContent.classList.remove('hidden');
      chineseContent.classList.add('hidden');
      taiwaneseContent.classList.add('hidden');
    } else if (tabId == 'chinese_tab') {
      japaneseTab.classList.remove('active');
      englishTab.classList.remove('active');
      chineseTab.classList.add('active');
      taiwaneseTab.classList.remove('active');

      japaneseContent.classList.add('hidden');
      englishContent.classList.add('hidden');
      chineseContent.classList.remove('hidden');
      taiwaneseContent.classList.add('hidden');
    } else {
      japaneseTab.classList.remove('active');
      englishTab.classList.remove('active');
      chineseTab.classList.remove('active');
      taiwaneseTab.classList.add('active');

      japaneseContent.classList.add('hidden');
      englishContent.classList.add('hidden');
      chineseContent.classList.add('hidden');
      taiwaneseContent.classList.remove('hidden');
    }
  }

  const selectElement = document.querySelector('#post_image');
  function image_input_btn() {
    selectElement.click();
  }

  document.getElementById('post_image').addEventListener('change', function (e) {
    // 1枚だけ表示する
    const file = e.target.files[0];
    // ファイルのブラウザ上でのURLを取得する
    const blobUrl = window.URL.createObjectURL(file);
    // img要素に表示
    const post_img = document.getElementById('user_image_prev');
    post_img.src = blobUrl;
    post_img.classList.toggle("hidden");
    const before_img = document.getElementById('user_present_image');
    before_img.classList.toggle("hidden");
  });

  function applySupplierAddress(obj) {
    var isChecked = obj.checked;
    var address_box = document.getElementById("address_box");
    if (isChecked) {
      address_box.classList.add("hidden");
    }
  }

  function hasOwnSupplierAddress(obj) {
    var isChecked = obj.checked;
    var address_box = document.getElementById("address_box");
    if (isChecked) {
      address_box.classList.remove("hidden");
    }
  }

  function applySupplierPhone(obj) {
    var isChecked = obj.checked;
    var phone_box = document.getElementById("phone_box");
    if (isChecked) {
      phone_box.classList.add("hidden");
    }
  }

  function hasOwnSupplierPhone(obj) {
    var isChecked = obj.checked;
    var phone_box = document.getElementById("phone_box");
    if (isChecked) {
      phone_box.classList.remove("hidden");
    }
  }

  function addIdToGuideItem(obj) {
    setTimeout(function(){
      const guideItems = document.querySelectorAll("div.nested-fields");
      for (var i = 0; i < guideItems.length; i++) {
        const guidePrevElement = guideItems[i].children[0].children[0].children[0];
        guidePrevElement.id = 'guide_image_prev'+i;
        const guidePresentElement = guideItems[i].children[0].children[0].getElementsByClassName('guide_present_image')[0];
        guidePresentElement.id = 'guide_present_image'+i;
        const guideImageInput = guideItems[i].children[0].children[0].getElementsByClassName('user_edit_image_upload_btn_box')[0].children[0];
        guideImageInput.id = i;
      }
    }, 100);
  }

  function showExplanation(obj) {
    const radioVal = obj.value;
    showExplanationWithValue(radioVal);
  }

  function showExplanationWithValue(value) {
    const theDayBefore = document.getElementById("explanation_about_the_day_before");
    const threeDaysBefore = document.getElementById("explanation_about_three_days_before");
    const aWeekBefore = document.getElementById("explanation_about_a_week_before");
    if (value == 'the_day_before') {
      theDayBefore.classList.remove('hidden');
      threeDaysBefore.classList.add('hidden');
      aWeekBefore.classList.add('hidden');
    } else if (value == 'three_days_before') {
      theDayBefore.classList.add('hidden');
      threeDaysBefore.classList.remove('hidden');
      aWeekBefore.classList.add('hidden');
    } else {
      theDayBefore.classList.add('hidden');
      threeDaysBefore.classList.add('hidden');
      aWeekBefore.classList.remove('hidden');
    }
  }
  </script>
