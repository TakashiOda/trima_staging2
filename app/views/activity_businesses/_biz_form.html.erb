<%= form_for [@supplier, @activity_business] do |form| %>
  <div class="form_title">
    <h3>体験事業の情報を編集</h3>
  </div>
  <div class="user_show_content_down">
    <%= render 'layouts/error_messages', model: form.object %>
    <div class="user_show_info_items_box">
      <section class="form_section">
        <div class="form_big_title">
          <h3>体験事業の基本情報</h3>
        </div>
        <div class="user_edit_image_container">
          <div class="form-group user_edit_image_box">
            <div class="user_edit_image_box_inside">
              <img id="user_image_prev" src="#" class="hidden" />
              <% if current_supplier && @activity_business.profile_image? %>
                <%= image_tag @activity_business.profile_image.to_s, class: 'user_present_image', id: 'user_present_image' %>
              <% else %>
                <%= image_tag 'default_images/no_avatar_image.png', class: 'user_present_image', id: 'user_present_image' %>
                <%= form.hidden_field :profile_image_cache %>
              <% end %>
            </div>
            <div id="user_edit_image_upload_btn_box">
              <%= form.file_field :profile_image, id: 'post_image' %>
              <span id="user_edit_image_upload_btn" onclick="image_input_btn()"><i class="fas fa-camera"></i></span>
            </div>
          </div>
        </div>
        <div class="activity_description_language_box">
          <ul class="activity_description_language_box_tab_list" role="tablist">
            <li id="japanese_tab" class="active" onclick="toggleDescriptionTab(this)">
              <span>日本語</span>
            </li>
            <li id="english_tab" onclick="toggleDescriptionTab(this)">
              <span>英語</span>
            </li>
            <li id="chinese_tab" onclick="toggleDescriptionTab(this)">
              <span>中国語（簡体字）</span>
            </li>
            <li id="taiwanese_tab" onclick="toggleDescriptionTab(this)">
              <span>中国語（繁体字）</span>
            </li>
          </ul>
          <div class="tab-content-items">
            <div id="japanese_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号" %>
                <%= form.text_field :name, required: true, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= form.label "体験の紹介文（日本語）" %>
                <%= form.text_area :profile_text, rows: 7, required: true, class: "form-control" %>
              </div>
            </div>
            <div class="hidden" id="english_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号（英語）" %>
                <%= form.text_field :en_name, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= form.label "プロフィール（英語）" %>
                <%= form.text_area :en_profile_text, size: "22x5", class: "form-control" %>
              </div>
            </div>
            <div class="hidden" id="chinese_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号（中国語・簡体字）" %>
                <%= form.text_field :cn_name, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= form.label "プロフィール（中国語・簡体字）" %>
                <%= form.text_area :cn_profile_text, size: "22x5", class: "form-control" %>
              </div>
            </div>
            <div class="hidden" id="taiwanese_tab_content">
              <div class="form-group">
                <%= form.label "体験事業名・屋号（中国語・繁体字）" %>
                <%= form.text_field :tw_name, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= form.label "プロフィール（中国語・繁体字）" %>
                <%= form.text_area :tw_profile_text, size: "22x5", class: "form-control" %>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>ガイド・案内人情報</h3>
        </div>
        <div id="guides">
          <%= form.fields_for :guides do |g| %>
            <%= render "guide_fields", f: g %>
          <% end %>
          <div class="links">
            <%= link_to_add_association "ガイドを追加", form, :guides, onClick: "addIdToGuideItem(this)" %>
          </div>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>対応可能言語</h3>
        </div>
        <div class="form-group language_activity_list">
          <%= form.collection_check_boxes :language_ids, Language.where(id: [3,26,28]), :id, :name %>
        </div>
      </section>
      <section class="form_section">
        <div class="form_big_title">
          <h3>所在地・連絡先</h3>
        </div>
        <div class="radio_item_box">
          <%= form.label "住所" %>
          <div class="radio_items">
            <div class="radio_item on">
              <%= form.radio_button :apply_suuplier_address, :true, onClick: "applySupplierAddress(this)" %>
              <%= form.label :apply_suuplier_address, "アカウント登録住所と同じ", {value: :true, style: "display: inline-block;"} %>
            </div>
            <div class="radio_item off">
              <%= form.radio_button :apply_suuplier_address, :false, onClick: "hasOwnSupplierAddress(this)" %>
              <%= form.label :apply_suuplier_address, "別の住所を設定する", {value: :false, style: "display: inline-block;"} %>
            </div>
          </div>
        </div>
        <div id="address_box" class="<%= "hidden" if @activity_business.apply_suuplier_address %>">
          <div class="form-group">
            <div class="form-group">
              <%= form.label "郵便番号" %>
              <%= form.text_field :post_code, class: "form-control" %>
            </div>
            <div class="row">
              <div class="col-half">
                <%= form.label "都道府県" %>
                <%# form.collection_select :prefecture_id, Prefecture.all, :id, :local_name,{prompt: "都道府県を選択"}, required: true, class: "form-control" %>
                <%= form.select :prefecture_id, {'北海道': 2}, { include_blank: false}, { class: 'form-control' } %>
              </div>
              <div class="col-half">
                <%= form.label "市区町村" %>
                <%= form.collection_select :town_id, Town.all, :id, :jp_name,{prompt: "市区町村を選択"}, class: "form-control" %>
              </div>
            </div>
            <div class="form-group">
              <%= form.label "住所" %>
              <%= form.text_field :detail_address, class: "form-control" %>
            </div>
            <div class="form-group">
              <%= form.label "建物名・部屋番号など" %>
              <%= form.text_field :building, class: "form-control" %>
            </div>
          </div>
        </div>
        <div class="radio_item_box">
          <%= form.label "電話番号" %>
          <div class="radio_items">
            <div class="radio_item on">
              <%= form.radio_button :apply_suuplier_phone, :true, onClick: "applySupplierPhone(this)" %>
              <%= form.label :apply_suuplier_phone, "アカウント登録電話番号と同じ", {value: :true, style: "display: inline-block;"} %>
            </div>
            <div class="radio_item off">
              <%= form.radio_button :apply_suuplier_phone, :false, onClick: "hasOwnSupplierPhone(this)" %>
              <%= form.label :apply_suuplier_phone, "別の電話番号を設定する", {value: :false, style: "display: inline-block;"} %>
            </div>
          </div>
        </div>
        <div id="phone_box" class="<%= "hidden" if @activity_business.apply_suuplier_phone %>">
          <div class="form-group">
            <%= form.label "別の電話番号を入力してください（ハイフンなし）" %>
            <%= form.text_field :phone, class: "form-control" %>
          </div>
        </div>
      </section>
    </div>
    <div class="user_show_info_button_box">
      <div class="form_sidebtns_container">
        <div class="form_sidebtns">
          <div class="form_sidebtn">
            <%= link_to "キャンセル", supplier_path(current_supplier), class: "button btn-cansel" %>
          </div>
          <div class="form_sidebtn">
            <%= form.submit('更新する',class: 'button btn-submit') %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script type="text/javascript">
  function toggleDescriptionTab(obj) {
    const tabId = obj.id;
    const japaneseTab = document.getElementById('japanese_tab');
    const englishTab = document.getElementById('english_tab');
    const chineseTab = document.getElementById('chinese_tab');
    const taiwaneseTab = document.getElementById('taiwanese_tab');

    const japaneseContent = document.getElementById('japanese_tab_content');
    const englishContent = document.getElementById('english_tab_content');
    const chineseContent = document.getElementById('chinese_tab_content');
    const taiwaneseContent = document.getElementById('taiwanese_tab_content');

    if (tabId == 'japanese_tab') {
      japaneseTab.classList.add('active');
      englishTab.classList.remove('active');
      chineseTab.classList.remove('active');
      taiwaneseTab.classList.remove('active');

      japaneseContent.classList.remove('hidden');
      englishContent.classList.add('hidden');
      chineseContent.classList.add('hidden');
      taiwaneseContent.classList.add('hidden');
    } else if (tabId == 'english_tab') {
      japaneseTab.classList.remove('active');
      englishTab.classList.add('active');
      chineseTab.classList.remove('active');
      taiwaneseTab.classList.remove('active');

      japaneseContent.classList.add('hidden');
      englishContent.classList.remove('hidden');
      chineseContent.classList.add('hidden');
      taiwaneseContent.classList.add('hidden');
    } else if (tabId == 'chinese_tab') {
      japaneseTab.classList.remove('active');
      englishTab.classList.remove('active');
      chineseTab.classList.add('active');
      taiwaneseTab.classList.remove('active');

      japaneseContent.classList.add('hidden');
      englishContent.classList.add('hidden');
      chineseContent.classList.remove('hidden');
      taiwaneseContent.classList.add('hidden');
    } else {
      japaneseTab.classList.remove('active');
      englishTab.classList.remove('active');
      chineseTab.classList.remove('active');
      taiwaneseTab.classList.add('active');

      japaneseContent.classList.add('hidden');
      englishContent.classList.add('hidden');
      chineseContent.classList.add('hidden');
      taiwaneseContent.classList.remove('hidden');
    }
  }

  const selectElement = document.querySelector('#post_image');
  function image_input_btn() {
    selectElement.click();
  }

  document.getElementById('post_image').addEventListener('change', function (e) {
    // 1枚だけ表示する
    const file = e.target.files[0];
    // ファイルのブラウザ上でのURLを取得する
    const blobUrl = window.URL.createObjectURL(file);
    // img要素に表示
    const post_img = document.getElementById('user_image_prev');
    post_img.src = blobUrl;
    post_img.classList.toggle("hidden");
    const before_img = document.getElementById('user_present_image');
    before_img.classList.toggle("hidden");
    // before_img.classList.remove("user_present_image");
  });

  function applySupplierAddress(obj) {
    var isChecked = obj.checked;
    var address_box = document.getElementById("address_box");
    if (isChecked) {
      address_box.classList.add("hidden");
    }
  }

  function hasOwnSupplierAddress(obj) {
    var isChecked = obj.checked;
    var address_box = document.getElementById("address_box");
    if (isChecked) {
      address_box.classList.remove("hidden");
    }
  }

  function applySupplierPhone(obj) {
    var isChecked = obj.checked;
    var phone_box = document.getElementById("phone_box");
    if (isChecked) {
      phone_box.classList.add("hidden");
    }
  }

  function hasOwnSupplierPhone(obj) {
    var isChecked = obj.checked;
    var phone_box = document.getElementById("phone_box");
    if (isChecked) {
      phone_box.classList.remove("hidden");
    }
  }

  function addIdToGuideItem(obj) {
    setTimeout(function(){
      // const nestedFields = obj.parentNode.parentNode.getElementsByClassName('nested-fields');
      // const nestedFieldsCount = nestedFields.length - 1;
      // const newGuideElement = nestedFields[nestedFieldsCount];
      const guideItems = document.querySelectorAll("div.nested-fields");
      for (var i = 0; i < guideItems.length; i++) {
        const guidePrevElement = guideItems[i].children[0].children[0].children[0];
        guidePrevElement.id = 'guide_image_prev'+i;
        // console.log(guide_prev.id);
        const guidePresentElement = guideItems[i].children[0].children[0].getElementsByClassName('guide_present_image')[0];
        guidePresentElement.id = 'guide_present_image'+i;
        const guideImageInput = guideItems[i].children[0].children[0].getElementsByClassName('user_edit_image_upload_btn_box')[0].children[0];
        guideImageInput.id = i;
      }
    }, 100);
  }
  </script>
